import{_ as s}from"./chunks/9olqLl7-x6XtWyNUssHvLGkRzM5cj2_KAPAYU4vaHIw.9541447f.js";import{_ as n,o as a,c as l,Q as p}from"./chunks/framework.e90f0c97.js";const h=JSON.parse('{"title":"8ï¼šTransformer","description":"","frontmatter":{"prev":{"text":"7.å¾ªç¯ç¥ç»ç½‘ç»œå®æˆ˜","link":"./7.å¾ªç¯ç¥ç»ç½‘ç»œå®æˆ˜.md"},"next":{"text":"9.BERT","link":"./9.BERT.md"}},"headers":[],"relativePath":"md/æœºå™¨å­¦ä¹ /8.Transformer.md","filePath":"md/æœºå™¨å­¦ä¹ /8.Transformer.md"}'),o={name:"md/æœºå™¨å­¦ä¹ /8.Transformer.md"},e=p('<p><img src="'+s+`" alt="9olqLl7-x6XtWyNUssHvLGkRzM5cj2_KAPAYU4vaHIw"></p><h1 id="_8-transformer" tabindex="-1">8ï¼šTransformer <a class="header-anchor" href="#_8-transformer" aria-label="Permalink to &quot;8ï¼šTransformer&quot;">â€‹</a></h1><h2 id="ğŸ¯-æ¬¢è¿è¿›å…¥aiçš„-æ ¸å¿ƒååº”å †" tabindex="-1">ğŸ¯ æ¬¢è¿è¿›å…¥AIçš„&quot;æ ¸å¿ƒååº”å †&quot;ï¼ <a class="header-anchor" href="#ğŸ¯-æ¬¢è¿è¿›å…¥aiçš„-æ ¸å¿ƒååº”å †" aria-label="Permalink to &quot;ğŸ¯ æ¬¢è¿è¿›å…¥AIçš„&quot;æ ¸å¿ƒååº”å †&quot;ï¼&quot;">â€‹</a></h2><p>æ­å–œä½ ï¼ğŸ‰ ç»è¿‡å‰é¢æ‰€æœ‰é¢˜ç›®çš„å†ç»ƒï¼Œä½ å·²ç»ä»AIå°ç™½æˆåŠŸè¿›é˜¶ã€‚ç°åœ¨ï¼Œæ˜¯æ—¶å€™æŒ‘æˆ˜<strong>ç°ä»£AIçš„æ ¸å¿ƒå¼•æ“</strong>â€”â€”<strong>Transformer</strong>äº†ï¼</p><p>è¿™ä¸ä»…ä»…æ˜¯ä¸€é“é¢˜ç›®ï¼Œæ›´æ˜¯ä¸€æ¬¡<strong>ä»å…¥é—¨åˆ°ç²¾é€š</strong>çš„åä¸½èœ•å˜ï¼ä»GPTåˆ°ChatGPTï¼Œä»BERTåˆ°Stable Diffusionï¼Œå‡ ä¹æ‰€æœ‰éœ‡æ’¼ä¸–ç•Œçš„AIæ¨¡å‹éƒ½ç¦»ä¸å¼€è¿™ä¸ªç¥å¥‡çš„æ¶æ„ã€‚</p><blockquote><p>ğŸš€ <strong>æ¿€åŠ¨äººå¿ƒçš„äº‹å®</strong>: ä½ å³å°†äº²æ‰‹å®ç°æ”¯æ’‘æ•´ä¸ªå¤§è¯­è¨€æ¨¡å‹æ—¶ä»£çš„æ ¸å¿ƒæŠ€æœ¯ï¼</p></blockquote><h2 id="ğŸ“š-å­¦ä¹ ç›®æ ‡" tabindex="-1">ğŸ“š å­¦ä¹ ç›®æ ‡ <a class="header-anchor" href="#ğŸ“š-å­¦ä¹ ç›®æ ‡" aria-label="Permalink to &quot;ğŸ“š å­¦ä¹ ç›®æ ‡&quot;">â€‹</a></h2><p>âœ… <strong>æ·±å…¥ç†è§£</strong> Transformeræ¶æ„çš„è®¾è®¡å“²å­¦ âœ… <strong>æŒæ¡æ³¨æ„åŠ›æœºåˆ¶</strong>çš„æ•°å­¦åŸç† âœ… <strong>MiniGPTå®æˆ˜</strong>ï¼šç†è®ºè½¬åŒ–ä¸ºä»£ç èƒ½åŠ› âœ… <strong>åŸ¹å…»ç‹¬ç«‹ç ”ç©¶</strong>è®ºæ–‡çš„èƒ½åŠ›</p><h2 id="ğŸ’¡-å­¦ä¹ å»ºè®®" tabindex="-1">ğŸ’¡ å­¦ä¹ å»ºè®® <a class="header-anchor" href="#ğŸ’¡-å­¦ä¹ å»ºè®®" aria-label="Permalink to &quot;ğŸ’¡ å­¦ä¹ å»ºè®®&quot;">â€‹</a></h2><ol><li><p><strong>ç†è®ºå…ˆè¡Œ</strong>: åœ¨å†™ä»£ç ä¹‹å‰ï¼Œç¡®ä¿è„‘æµ·ä¸­æœ‰æ¸…æ™°çš„æ¶æ„å›¾</p></li><li><p><strong>å¾ªåºæ¸è¿›</strong>: ä»å•å¤´æ³¨æ„åŠ›åˆ°å¤šå¤´ï¼Œä»ç®€å•åˆ°å¤æ‚</p></li><li><p><strong>å–„ç”¨è°ƒè¯•</strong>: æ¯ä¸€ä¸ªtensorçš„shapeå˜åŒ–éƒ½è¦å¿ƒä¸­æœ‰æ•°</p></li><li><p><strong>å¯¹æ¯”åˆ†æ</strong>: è°ƒå‚æ•°ï¼Œçœ‹å˜åŒ–ï¼Œåšä¸€ä¸ª&quot;è¶…å‚æ•°çŒäºº&quot;</p></li><li><p><strong>å»¶ä¼¸æ€è€ƒ</strong>: æƒ³æƒ³å¦‚ä½•è®©ä½ çš„æ¨¡å‹æ›´å¼ºæ›´å¿«</p></li></ol><p>âš ï¸ <strong>é‡è¦æé†’</strong>: è™½ç„¶è¿™é¢˜å¾ˆç¡¬æ ¸ï¼Œä½†å®Œæˆåä½ å°†<strong>ä»å…¥é—¨ç›´è¾¾ç²¾é€š</strong>ï¼è¿™å¯èƒ½æ˜¯ä½ ç¼–ç¨‹ç”Ÿæ¶¯ä¸­æœ€æœ‰æˆå°±æ„Ÿçš„æ—¶åˆ»ä¹‹ä¸€ï¼åŒæ—¶ä¹Ÿæ˜¯é¢è¯•ä¸­çš„é‡ç‚¹é¢˜ç›®å–”~</p><h2 id="ğŸ”¥-ç¬¬ä¸€éƒ¨åˆ†-ç†è®ºåŸºç¡€é—®ç­”" tabindex="-1">ğŸ”¥ ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è®ºåŸºç¡€é—®ç­” <a class="header-anchor" href="#ğŸ”¥-ç¬¬ä¸€éƒ¨åˆ†-ç†è®ºåŸºç¡€é—®ç­”" aria-label="Permalink to &quot;ğŸ”¥ ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è®ºåŸºç¡€é—®ç­”&quot;">â€‹</a></h2><h3 id="attention-is-all-you-need" tabindex="-1">Attention is all you needï¼ <a class="header-anchor" href="#attention-is-all-you-need" aria-label="Permalink to &quot;Attention is all you needï¼&quot;">â€‹</a></h3><p>åœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆ&quot;æ‹·é—®&quot;ä¸€ä¸‹Transformerçš„çµé­‚ï¼</p><p>** å¿…ç­”é¢˜æ¸…å•ï¼š**</p><ol><li><p><strong>Transformerçš„ç‰¹ç‚¹</strong>æ˜¯ä»€ä¹ˆï¼Ÿä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿç¼ºç‚¹åˆæ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>ğŸ” <strong>ä»»åŠ¡</strong>: åœ¨åŸè®ºæ–‡ä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®å¹¶æ ‡æ³¨</li></ul></li><li><p><strong>Layer Norm vs Batch Norm</strong></p><ul><li>ğŸ¤” è¿™ä¸¤ä¸ª&quot;æ ‡å‡†åŒ–å…„å¼Ÿ&quot;æœ‰ä»€ä¹ˆæ©æ€¨æƒ…ä»‡ï¼Ÿ</li></ul></li><li><p><strong>ä½ç½®ç¼–ç  (Positional Encoding)</strong></p><ul><li><p><strong>æ·±åº¦è§£æ</strong>: ä»€ä¹ˆæ˜¯ä½ç½®ç¼–ç ï¼Ÿ</p></li><li><p>Transformerç”¨äº†æ€æ ·çš„ä½ç½®ç¼–ç ï¼Ÿ</p></li><li><p>è¿™ç§è®¾è®¡çš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ</p></li></ul></li><li><p><strong>Encoder &amp; Decoder æ¶æ„è§£æ</strong></p><ul><li><p><strong>ç”»å›¾ + æ–‡å­—</strong>: è¯¦ç»†è¯´æ˜ä¸¤ä¸ªæ¨¡å—çš„ç»“æ„</p></li><li><p>æ•°æ®æ˜¯å¦‚ä½•åœ¨å…¶ä¸­æµåŠ¨çš„ï¼Ÿ</p></li><li><p>ğŸ¯ <strong>é¢è¯•é‡ç‚¹</strong>: åŠ¡å¿…ææ‡‚æ¯ä¸ªç»†èŠ‚ï¼</p></li></ul></li><li><p><strong>æ³¨æ„åŠ›æœºåˆ¶æ ¸å¿ƒé—®é¢˜</strong></p><ul><li><p><strong>K, Q, V</strong>åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆï¼Ÿå¦‚ä½•å˜åŒ–ï¼Ÿ</p></li><li><p><strong>QÃ—K^T</strong>çš„æ•°å­¦å†…æ¶µæ˜¯ä»€ä¹ˆï¼Ÿ</p></li><li><p><strong>Scaled Dot-Product Attention</strong> vs <strong>Additive Attention</strong></p></li></ul></li><li><p><strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„&quot;è‡ª&quot;</strong></p><ul><li>è¿™ä¸ª&quot;è‡ª&quot;å­—ä½“ç°åœ¨å“ªé‡Œï¼Ÿä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ</li></ul></li><li><p><strong>å¯å­¦ä¹ å‚æ•°åˆ†æ</strong></p><ul><li><p>æ³¨æ„åŠ›æœºåˆ¶ä¸­æœ‰éœ€è¦å­¦ä¹ çš„å‚æ•°å—ï¼Ÿ</p></li><li><p>å¤šå¤´æ³¨æ„åŠ›ä¸­å‘¢ï¼Ÿ</p></li><li><p>æˆ‘ä»¬å¸Œæœ›è¿™äº›å‚æ•°å­¦åˆ°ä»€ä¹ˆï¼Ÿ</p></li></ul></li><li><p><strong>æ•°æ®æµåŠ¨å…¨è§£æ</strong></p><ul><li><p>æ–‡æœ¬è¾“å…¥åï¼Œå„ä¸ªç»´åº¦æ˜¯å¦‚ä½•å˜åŒ–çš„ï¼Ÿ</p></li><li><p>ä»tokenåˆ°embeddingåˆ°è¾“å‡ºçš„å®Œæ•´è¿‡ç¨‹</p></li></ul></li><li><p><strong>BLEUè¯„ä¼°æŒ‡æ ‡</strong></p><ul><li>BLEUæ˜¯ä»€ä¹ˆï¼Ÿåœ¨NLPä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ</li></ul></li></ol><hr><h2 id="ç¬¬äºŒéƒ¨åˆ†-minigptå®æˆ˜æŒ‘æˆ˜" tabindex="-1">ç¬¬äºŒéƒ¨åˆ†ï¼šMiniGPTå®æˆ˜æŒ‘æˆ˜ <a class="header-anchor" href="#ç¬¬äºŒéƒ¨åˆ†-minigptå®æˆ˜æŒ‘æˆ˜" aria-label="Permalink to &quot;ç¬¬äºŒéƒ¨åˆ†ï¼šMiniGPTå®æˆ˜æŒ‘æˆ˜&quot;">â€‹</a></h2><blockquote><p><em>&quot;çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ&quot;</em></p></blockquote><p>å‡†å¤‡å¥½æ’¸èµ·è¢–å­ï¼Œæ‰‹æ“ä¸€ä¸ª<strong>è¿·ä½ ç‰ˆGPT</strong>äº†å—ï¼Ÿ</p><h3 id="ğŸ®-å®æˆ˜ç¯å¢ƒå‡†å¤‡" tabindex="-1">ğŸ® å®æˆ˜ç¯å¢ƒå‡†å¤‡ <a class="header-anchor" href="#ğŸ®-å®æˆ˜ç¯å¢ƒå‡†å¤‡" aria-label="Permalink to &quot;ğŸ® å®æˆ˜ç¯å¢ƒå‡†å¤‡&quot;">â€‹</a></h3><p><strong>ç¡¬ä»¶éœ€æ±‚</strong>: å¼ºçƒˆå»ºè®®ä½¿ç”¨äº‘ç«¯GPUï¼ˆå‚è€ƒç¬¬0é¢˜ç™½å«–æ”»ç•¥ï¼‰</p><p><strong>å·¥å…·</strong>: Jupyter Lab</p><h3 id="_1ï¸âƒ£-æ•°æ®é›†è·å–" tabindex="-1">1ï¸âƒ£ æ•°æ®é›†è·å– <a class="header-anchor" href="#_1ï¸âƒ£-æ•°æ®é›†è·å–" aria-label="Permalink to &quot;1ï¸âƒ£ æ•°æ®é›†è·å–&quot;">â€‹</a></h3><p><strong>tinyshakespeareæ•°æ®é›†</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://raw.githubusercontent.com/karpathy/char-rnn/master/data/tinyshakespeare/input.txt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://raw.githubusercontent.com/karpathy/char-rnn/master/data/tinyshakespeare/input.txt</span></span></code></pre></div><blockquote><p>ğŸ’¡ <strong>å·æ‡’æŒ‡å—</strong>: æ•°æ®é›†å¾ˆå°ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´åˆ°txtæ–‡ä»¶ä¹ŸOKï¼</p></blockquote><h3 id="_2ï¸âƒ£-è¶…å‚æ•°é…ç½®" tabindex="-1">2ï¸âƒ£ è¶…å‚æ•°é…ç½® <a class="header-anchor" href="#_2ï¸âƒ£-è¶…å‚æ•°é…ç½®" aria-label="Permalink to &quot;2ï¸âƒ£ è¶…å‚æ•°é…ç½®&quot;">â€‹</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> torch</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> torch.nn </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> nn</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> torch.nn </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> functional </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> F</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> matplotlib.pyplot </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> plt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## è¶…å‚è®¾ç½®ï¼ˆæ¯ä¸ªå‚æ•°éƒ½æœ‰è®²ç©¶ï¼ï¼‰</span></span>
<span class="line"><span style="color:#E1E4E8;">batch_size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;"># æ‰¹å¤„ç†å¤§å°</span></span>
<span class="line"><span style="color:#E1E4E8;">block_size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;"># ä¸Šä¸‹æ–‡é•¿åº¦</span></span>
<span class="line"><span style="color:#E1E4E8;">max_iters </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># è®­ç»ƒè½®æ•°</span></span>
<span class="line"><span style="color:#E1E4E8;">learning_rate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1e-3</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># å­¦ä¹ ç‡</span></span>
<span class="line"><span style="color:#E1E4E8;">device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;cuda&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> torch.cuda.is_available() </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;cpu&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">n_embd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;"># embeddingç»´åº¦</span></span>
<span class="line"><span style="color:#E1E4E8;">n_head </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;"># å¤šå¤´æ³¨æ„åŠ›å¤´æ•°</span></span>
<span class="line"><span style="color:#E1E4E8;">n_layer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;"># transformerå±‚æ•°</span></span>
<span class="line"><span style="color:#E1E4E8;">dropout </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;"># dropoutç‡</span></span>
<span class="line"><span style="color:#E1E4E8;">torch.manual_seed(</span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;"># éšæœºç§å­ï¼Œä¿è¯å¯å¤ç°</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> torch</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> torch.nn </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> nn</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> torch.nn </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> functional </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> F</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> matplotlib.pyplot </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> plt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## è¶…å‚è®¾ç½®ï¼ˆæ¯ä¸ªå‚æ•°éƒ½æœ‰è®²ç©¶ï¼ï¼‰</span></span>
<span class="line"><span style="color:#24292E;">batch_size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">     </span><span style="color:#6A737D;"># æ‰¹å¤„ç†å¤§å°</span></span>
<span class="line"><span style="color:#24292E;">block_size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">32</span><span style="color:#24292E;">     </span><span style="color:#6A737D;"># ä¸Šä¸‹æ–‡é•¿åº¦</span></span>
<span class="line"><span style="color:#24292E;">max_iters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5000</span><span style="color:#24292E;">    </span><span style="color:#6A737D;"># è®­ç»ƒè½®æ•°</span></span>
<span class="line"><span style="color:#24292E;">learning_rate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1e-3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># å­¦ä¹ ç‡</span></span>
<span class="line"><span style="color:#24292E;">device </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;cuda&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> torch.cuda.is_available() </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;cpu&#39;</span></span>
<span class="line"><span style="color:#24292E;">n_embd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">64</span><span style="color:#24292E;">         </span><span style="color:#6A737D;"># embeddingç»´åº¦</span></span>
<span class="line"><span style="color:#24292E;">n_head </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">          </span><span style="color:#6A737D;"># å¤šå¤´æ³¨æ„åŠ›å¤´æ•°</span></span>
<span class="line"><span style="color:#24292E;">n_layer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#6A737D;"># transformerå±‚æ•°</span></span>
<span class="line"><span style="color:#24292E;">dropout </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;">       </span><span style="color:#6A737D;"># dropoutç‡</span></span>
<span class="line"><span style="color:#24292E;">torch.manual_seed(</span><span style="color:#005CC5;">42</span><span style="color:#24292E;">) </span><span style="color:#6A737D;"># éšæœºç§å­ï¼Œä¿è¯å¯å¤ç°</span></span></code></pre></div><h3 id="_3ï¸âƒ£-æ•°æ®é¢„å¤„ç†" tabindex="-1">3ï¸âƒ£ æ•°æ®é¢„å¤„ç† <a class="header-anchor" href="#_3ï¸âƒ£-æ•°æ®é¢„å¤„ç†" aria-label="Permalink to &quot;3ï¸âƒ£ æ•°æ®é¢„å¤„ç†&quot;">â€‹</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># è¯»å–èå£«æ¯”äºšæ–‡æœ¬</span></span>
<span class="line"><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">open</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;input.txt&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;r&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">encoding</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> f:</span></span>
<span class="line"><span style="color:#E1E4E8;">    text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> f.read()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;æ•°æ®é›†æ€»å­—ç¬¦æ•°: </span><span style="color:#79B8FF;">{len</span><span style="color:#E1E4E8;">(text)</span><span style="color:#F97583;">:,</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;å‰300ä¸ªå­—ç¬¦é¢„è§ˆ:</span><span style="color:#79B8FF;">\\n{</span><span style="color:#E1E4E8;">text[:</span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">]</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># æ„å»ºè¯æ±‡è¡¨</span></span>
<span class="line"><span style="color:#E1E4E8;">chars </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sorted</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">list</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;">(text)))</span></span>
<span class="line"><span style="color:#E1E4E8;">vocab_size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(chars)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;è¯æ±‡è¡¨: </span><span style="color:#79B8FF;">{</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">.join(chars)</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;è¯æ±‡è¡¨å¤§å°: </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">vocab_size</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç®€å•tokenizerå®ç°</span></span>
<span class="line"><span style="color:#E1E4E8;">stoi </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {ch: i </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i, ch </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">enumerate</span><span style="color:#E1E4E8;">(chars)}</span></span>
<span class="line"><span style="color:#E1E4E8;">itos </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {i: ch </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i, ch </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">enumerate</span><span style="color:#E1E4E8;">(chars)}</span></span>
<span class="line"><span style="color:#E1E4E8;">encode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">lambda</span><span style="color:#E1E4E8;"> s: [stoi[c] </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> s]</span></span>
<span class="line"><span style="color:#E1E4E8;">decode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">lambda</span><span style="color:#E1E4E8;"> l: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">.join([itos[i] </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> l])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># æµ‹è¯•ç¼–è§£ç </span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;ç¼–ç æµ‹è¯•: </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">encode(</span><span style="color:#9ECBFF;">&#39;Hello World!&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;è§£ç æµ‹è¯•: </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">decode(encode(</span><span style="color:#9ECBFF;">&#39;Hello World!&#39;</span><span style="color:#E1E4E8;">))</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># è¯»å–èå£«æ¯”äºšæ–‡æœ¬</span></span>
<span class="line"><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">open</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;input.txt&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;r&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">encoding</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;utf-8&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> f:</span></span>
<span class="line"><span style="color:#24292E;">    text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> f.read()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;æ•°æ®é›†æ€»å­—ç¬¦æ•°: </span><span style="color:#005CC5;">{len</span><span style="color:#24292E;">(text)</span><span style="color:#D73A49;">:,</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;å‰300ä¸ªå­—ç¬¦é¢„è§ˆ:</span><span style="color:#005CC5;">\\n{</span><span style="color:#24292E;">text[:</span><span style="color:#005CC5;">300</span><span style="color:#24292E;">]</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># æ„å»ºè¯æ±‡è¡¨</span></span>
<span class="line"><span style="color:#24292E;">chars </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sorted</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">list</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">set</span><span style="color:#24292E;">(text)))</span></span>
<span class="line"><span style="color:#24292E;">vocab_size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(chars)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;è¯æ±‡è¡¨: </span><span style="color:#005CC5;">{</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">.join(chars)</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;è¯æ±‡è¡¨å¤§å°: </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">vocab_size</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç®€å•tokenizerå®ç°</span></span>
<span class="line"><span style="color:#24292E;">stoi </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {ch: i </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i, ch </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">enumerate</span><span style="color:#24292E;">(chars)}</span></span>
<span class="line"><span style="color:#24292E;">itos </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {i: ch </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i, ch </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">enumerate</span><span style="color:#24292E;">(chars)}</span></span>
<span class="line"><span style="color:#24292E;">encode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> s: [stoi[c] </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> s]</span></span>
<span class="line"><span style="color:#24292E;">decode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">lambda</span><span style="color:#24292E;"> l: </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">.join([itos[i] </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> l])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># æµ‹è¯•ç¼–è§£ç </span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;ç¼–ç æµ‹è¯•: </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">encode(</span><span style="color:#032F62;">&#39;Hello World!&#39;</span><span style="color:#24292E;">)</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;è§£ç æµ‹è¯•: </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">decode(encode(</span><span style="color:#032F62;">&#39;Hello World!&#39;</span><span style="color:#24292E;">))</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="_4ï¸âƒ£-æ•°æ®åˆ†æ‰¹å¤„ç†" tabindex="-1">4ï¸âƒ£ æ•°æ®åˆ†æ‰¹å¤„ç† <a class="header-anchor" href="#_4ï¸âƒ£-æ•°æ®åˆ†æ‰¹å¤„ç†" aria-label="Permalink to &quot;4ï¸âƒ£ æ•°æ®åˆ†æ‰¹å¤„ç†&quot;">â€‹</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">get_batch</span><span style="color:#E1E4E8;">(split):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">    ç”Ÿæˆè®­ç»ƒæ‰¹æ¬¡æ•°æ®</span></span>
<span class="line"><span style="color:#9ECBFF;">    </span></span>
<span class="line"><span style="color:#9ECBFF;">    ä½ éœ€è¦å®ç°ï¼š</span></span>
<span class="line"><span style="color:#9ECBFF;">    1. ä»è®­ç»ƒ/éªŒè¯é›†ä¸­éšæœºé‡‡æ ·</span></span>
<span class="line"><span style="color:#9ECBFF;">    2. ç”Ÿæˆè¾“å…¥åºåˆ—xå’Œç›®æ ‡åºåˆ—y  </span></span>
<span class="line"><span style="color:#9ECBFF;">    3. è¿”å›æ­£ç¡®ç»´åº¦çš„tensor</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># ä½ çš„ä»£ç åœ¨è¿™é‡Œ</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">pass</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get_batch</span><span style="color:#24292E;">(split):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#032F62;">    ç”Ÿæˆè®­ç»ƒæ‰¹æ¬¡æ•°æ®</span></span>
<span class="line"><span style="color:#032F62;">    </span></span>
<span class="line"><span style="color:#032F62;">    ä½ éœ€è¦å®ç°ï¼š</span></span>
<span class="line"><span style="color:#032F62;">    1. ä»è®­ç»ƒ/éªŒè¯é›†ä¸­éšæœºé‡‡æ ·</span></span>
<span class="line"><span style="color:#032F62;">    2. ç”Ÿæˆè¾“å…¥åºåˆ—xå’Œç›®æ ‡åºåˆ—y  </span></span>
<span class="line"><span style="color:#032F62;">    3. è¿”å›æ­£ç¡®ç»´åº¦çš„tensor</span></span>
<span class="line"><span style="color:#032F62;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># ä½ çš„ä»£ç åœ¨è¿™é‡Œ</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">pass</span></span></code></pre></div><h3 id="_5ï¸âƒ£-æ¨¡å‹æ¶æ„å®ç°" tabindex="-1">5ï¸âƒ£ æ¨¡å‹æ¶æ„å®ç° <a class="header-anchor" href="#_5ï¸âƒ£-æ¨¡å‹æ¶æ„å®ç°" aria-label="Permalink to &quot;5ï¸âƒ£ æ¨¡å‹æ¶æ„å®ç°&quot;">â€‹</a></h3><p><strong>ğŸ”¥ è¿™æ˜¯æ•´ä¸ªé¡¹ç›®çš„æ ¸å¿ƒï¼å¿…é¡»æ‰‹å·¥å®ç°ï¼</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Head</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Module</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;å•å¤´è‡ªæ³¨æ„åŠ›&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self, head_size):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">().</span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># QKVæŠ•å½±çŸ©é˜µ</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.key </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Linear(n_embd, head_size, </span><span style="color:#FFAB70;">bias</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">False</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.query </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Linear(n_embd, head_size, </span><span style="color:#FFAB70;">bias</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">False</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Linear(n_embd, head_size, </span><span style="color:#FFAB70;">bias</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">False</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># ä¸‹ä¸‰è§’maskçŸ©é˜µï¼ˆé˜²æ­¢çœ‹åˆ°æœªæ¥ï¼‰</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.register_buffer(</span><span style="color:#9ECBFF;">&#39;tril&#39;</span><span style="color:#E1E4E8;">, torch.tril(torch.ones(block_size, block_size)))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.dropout </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Dropout(dropout)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">forward</span><span style="color:#E1E4E8;">(self, x):</span></span>
<span class="line"><span style="color:#E1E4E8;">        B, T, C </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> x.shape</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># æ³¨æ„åŠ›è®¡ç®—é€»è¾‘</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 1. è®¡ç®—Q, K, V</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 2. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 3. åº”ç”¨mask</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 4. åŠ æƒæ±‚å’Œ</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MultiHeadAttention</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Module</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;å¤šå¤´æ³¨æ„åŠ›ï¼šå¹¶è¡Œå¤„ç†å¤šä¸ªæ³¨æ„åŠ›å¤´&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self, num_heads, head_size):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">().</span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.heads </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.ModuleList([Head(head_size) </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _ </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">range</span><span style="color:#E1E4E8;">(num_heads)])</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.proj </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Linear(n_embd, n_embd)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.dropout </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Dropout(dropout)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">forward</span><span style="color:#E1E4E8;">(self, x):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># å¤šå¤´å¹¶è¡Œè®¡ç®—ä¸åˆå¹¶</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FeedForward</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Module</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;å‰é¦ˆç¥ç»ç½‘ç»œï¼šç®€å•è€Œå¼ºå¤§&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># å®ç°ä¸¤å±‚çº¿æ€§å˜æ¢+æ¿€æ´»</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Block</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Module</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;Transformer Blockï¼šcommunication + computation&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># ç»„è£…å®Œæ•´çš„transformerå—</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># LayerNorm + MultiHeadAttention + LayerNorm + FeedForward</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BigramLanguageModel</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Module</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;å®Œæ•´çš„è¯­è¨€æ¨¡å‹&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">().</span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># embeddingè¡¨</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.token_embedding_table </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Embedding(vocab_size, n_embd)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.position_embedding_table </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Embedding(block_size, n_embd)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># å †å transformerå—</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.blocks </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Sequential(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">[Block(n_embd, </span><span style="color:#FFAB70;">n_head</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">n_head) </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _ </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">range</span><span style="color:#E1E4E8;">(n_layer)])</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.ln_f </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.LayerNorm(n_embd)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.lm_head </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nn.Linear(n_embd, vocab_size)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">forward</span><span style="color:#E1E4E8;">(self, idx, targets</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># å®Œæ•´å‰å‘ä¼ æ’­</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 1. token + position embedding</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 2. é€šè¿‡transformerå—</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 3. è¾“å‡ºé¢„æµ‹</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 4. è®¡ç®—æŸå¤±ï¼ˆå¦‚æœæœ‰targetï¼‰</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">pass</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">generate</span><span style="color:#E1E4E8;">(self, idx, max_new_tokens):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;&quot;&quot;æ–‡æœ¬ç”Ÿæˆï¼šè®©AIè¯´è¯ï¼&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _ </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">range</span><span style="color:#E1E4E8;">(max_new_tokens):</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># è£å‰ªåˆ°block_size</span></span>
<span class="line"><span style="color:#E1E4E8;">            idx_cond </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> idx[:, </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">block_size:]</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># é¢„æµ‹ä¸‹ä¸€ä¸ªtoken</span></span>
<span class="line"><span style="color:#E1E4E8;">            logits, _ </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">(idx_cond)</span></span>
<span class="line"><span style="color:#E1E4E8;">            logits </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> logits[:, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, :]  </span><span style="color:#6A737D;"># åªè¦æœ€åä¸€ä¸ªæ—¶é—´æ­¥</span></span>
<span class="line"><span style="color:#E1E4E8;">            probs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> F.softmax(logits, </span><span style="color:#FFAB70;">dim</span><span style="color:#F97583;">=-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># é‡‡æ ·ä¸‹ä¸€ä¸ªtoken</span></span>
<span class="line"><span style="color:#E1E4E8;">            idx_next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> torch.multinomial(probs, </span><span style="color:#FFAB70;">num_samples</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            idx </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> torch.cat((idx, idx_next), </span><span style="color:#FFAB70;">dim</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> idx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Head</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">nn</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Module</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;å•å¤´è‡ªæ³¨æ„åŠ›&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self, head_size):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">().</span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># QKVæŠ•å½±çŸ©é˜µ</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.key </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Linear(n_embd, head_size, </span><span style="color:#E36209;">bias</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.query </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Linear(n_embd, head_size, </span><span style="color:#E36209;">bias</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Linear(n_embd, head_size, </span><span style="color:#E36209;">bias</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">False</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># ä¸‹ä¸‰è§’maskçŸ©é˜µï¼ˆé˜²æ­¢çœ‹åˆ°æœªæ¥ï¼‰</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.register_buffer(</span><span style="color:#032F62;">&#39;tril&#39;</span><span style="color:#24292E;">, torch.tril(torch.ones(block_size, block_size)))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.dropout </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Dropout(dropout)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">forward</span><span style="color:#24292E;">(self, x):</span></span>
<span class="line"><span style="color:#24292E;">        B, T, C </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> x.shape</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># æ³¨æ„åŠ›è®¡ç®—é€»è¾‘</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 1. è®¡ç®—Q, K, V</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 2. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 3. åº”ç”¨mask</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 4. åŠ æƒæ±‚å’Œ</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MultiHeadAttention</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">nn</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Module</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;å¤šå¤´æ³¨æ„åŠ›ï¼šå¹¶è¡Œå¤„ç†å¤šä¸ªæ³¨æ„åŠ›å¤´&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self, num_heads, head_size):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">().</span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.heads </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.ModuleList([Head(head_size) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _ </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">range</span><span style="color:#24292E;">(num_heads)])</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.proj </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Linear(n_embd, n_embd)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.dropout </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Dropout(dropout)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">forward</span><span style="color:#24292E;">(self, x):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># å¤šå¤´å¹¶è¡Œè®¡ç®—ä¸åˆå¹¶</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FeedForward</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">nn</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Module</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;å‰é¦ˆç¥ç»ç½‘ç»œï¼šç®€å•è€Œå¼ºå¤§&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># å®ç°ä¸¤å±‚çº¿æ€§å˜æ¢+æ¿€æ´»</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Block</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">nn</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Module</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;Transformer Blockï¼šcommunication + computation&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># ç»„è£…å®Œæ•´çš„transformerå—</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># LayerNorm + MultiHeadAttention + LayerNorm + FeedForward</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BigramLanguageModel</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">nn</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">Module</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;å®Œæ•´çš„è¯­è¨€æ¨¡å‹&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">().</span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># embeddingè¡¨</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.token_embedding_table </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Embedding(vocab_size, n_embd)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.position_embedding_table </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Embedding(block_size, n_embd)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># å †å transformerå—</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.blocks </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Sequential(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">[Block(n_embd, </span><span style="color:#E36209;">n_head</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">n_head) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _ </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">range</span><span style="color:#24292E;">(n_layer)])</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.ln_f </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.LayerNorm(n_embd)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.lm_head </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nn.Linear(n_embd, vocab_size)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">forward</span><span style="color:#24292E;">(self, idx, targets</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">None</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># å®Œæ•´å‰å‘ä¼ æ’­</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 1. token + position embedding</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 2. é€šè¿‡transformerå—</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 3. è¾“å‡ºé¢„æµ‹</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 4. è®¡ç®—æŸå¤±ï¼ˆå¦‚æœæœ‰targetï¼‰</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">pass</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">generate</span><span style="color:#24292E;">(self, idx, max_new_tokens):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&quot;&quot;&quot;æ–‡æœ¬ç”Ÿæˆï¼šè®©AIè¯´è¯ï¼&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _ </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">range</span><span style="color:#24292E;">(max_new_tokens):</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># è£å‰ªåˆ°block_size</span></span>
<span class="line"><span style="color:#24292E;">            idx_cond </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> idx[:, </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">block_size:]</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># é¢„æµ‹ä¸‹ä¸€ä¸ªtoken</span></span>
<span class="line"><span style="color:#24292E;">            logits, _ </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">(idx_cond)</span></span>
<span class="line"><span style="color:#24292E;">            logits </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> logits[:, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, :]  </span><span style="color:#6A737D;"># åªè¦æœ€åä¸€ä¸ªæ—¶é—´æ­¥</span></span>
<span class="line"><span style="color:#24292E;">            probs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> F.softmax(logits, </span><span style="color:#E36209;">dim</span><span style="color:#D73A49;">=-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># é‡‡æ ·ä¸‹ä¸€ä¸ªtoken</span></span>
<span class="line"><span style="color:#24292E;">            idx_next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.multinomial(probs, </span><span style="color:#E36209;">num_samples</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            idx </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.cat((idx, idx_next), </span><span style="color:#E36209;">dim</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> idx</span></span></code></pre></div><h3 id="_6ï¸âƒ£-æ¨¡å‹è¯„ä¼°-ğŸ“Š" tabindex="-1">6ï¸âƒ£ æ¨¡å‹è¯„ä¼° ğŸ“Š <a class="header-anchor" href="#_6ï¸âƒ£-æ¨¡å‹è¯„ä¼°-ğŸ“Š" aria-label="Permalink to &quot;6ï¸âƒ£ æ¨¡å‹è¯„ä¼° ğŸ“Š&quot;">â€‹</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">@torch.no_grad</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">estimate_loss</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;&quot;&quot;è¯„ä¼°è®­ç»ƒå’ŒéªŒè¯æŸå¤±&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    out </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    model.eval()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># è®¡ç®—å¹³å‡æŸå¤±</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    model.train()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> out</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">@torch.no_grad</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">estimate_loss</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;&quot;&quot;è¯„ä¼°è®­ç»ƒå’ŒéªŒè¯æŸå¤±&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    out </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">    model.eval()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># è®¡ç®—å¹³å‡æŸå¤±</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    model.train()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> out</span></span></code></pre></div><h3 id="_7ï¸âƒ£-æ¨¡å‹è®­ç»ƒ" tabindex="-1">7ï¸âƒ£ æ¨¡å‹è®­ç»ƒ <a class="header-anchor" href="#_7ï¸âƒ£-æ¨¡å‹è®­ç»ƒ" aria-label="Permalink to &quot;7ï¸âƒ£ æ¨¡å‹è®­ç»ƒ&quot;">â€‹</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># å®ä¾‹åŒ–æ¨¡å‹</span></span>
<span class="line"><span style="color:#E1E4E8;">model </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> BigramLanguageModel().to(device)</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;æ¨¡å‹å‚æ•°é‡: </span><span style="color:#79B8FF;">{sum</span><span style="color:#E1E4E8;">(p.numel() </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> model.parameters())</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1e6</span><span style="color:#F97583;">:.2f</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">M&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># è®­ç»ƒå¾ªç¯</span></span>
<span class="line"><span style="color:#E1E4E8;">optimizer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> torch.optim.AdamW(model.parameters(), </span><span style="color:#FFAB70;">lr</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">learning_rate)</span></span>
<span class="line"><span style="color:#E1E4E8;">train_losses, val_losses </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [], []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">iter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">range</span><span style="color:#E1E4E8;">(max_iters):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># è®­ç»ƒå¾ªç¯å®ç°</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 1. è·å–batch</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 2. å‰å‘ä¼ æ’­</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 3. è®¡ç®—æŸå¤±</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 4. åå‘ä¼ æ’­</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 5. å‚æ•°æ›´æ–°</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 6. å®šæœŸè¯„ä¼°</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç»˜åˆ¶æŸå¤±æ›²çº¿</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.figure(</span><span style="color:#FFAB70;">figsize</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.plot(train_losses, </span><span style="color:#FFAB70;">label</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Train Loss&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">color</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;#FF6B6B&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.plot(val_losses, </span><span style="color:#FFAB70;">label</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Validation Loss&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">color</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;#4ECDC4&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.xlabel(</span><span style="color:#9ECBFF;">&#39;Iteration&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.ylabel(</span><span style="color:#9ECBFF;">&#39;Loss&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.title(</span><span style="color:#9ECBFF;">&#39;Training Progress: Loss Curves&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.legend()</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.grid(</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">alpha</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.savefig(</span><span style="color:#9ECBFF;">&#39;loss_plot.png&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">dpi</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">bbox_inches</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;tight&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç”Ÿæˆèå£«æ¯”äºšé£æ ¼æ–‡æœ¬</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;AIèå£«æ¯”äºšå¼€å§‹åˆ›ä½œ...&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">context </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> torch.zeros((</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">), </span><span style="color:#FFAB70;">dtype</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">torch.long, </span><span style="color:#FFAB70;">device</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">device)</span></span>
<span class="line"><span style="color:#E1E4E8;">generated_text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> decode(model.generate(context, </span><span style="color:#FFAB70;">max_new_tokens</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].tolist())</span></span>
<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(generated_text)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># å®ä¾‹åŒ–æ¨¡å‹</span></span>
<span class="line"><span style="color:#24292E;">model </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> BigramLanguageModel().to(device)</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;æ¨¡å‹å‚æ•°é‡: </span><span style="color:#005CC5;">{sum</span><span style="color:#24292E;">(p.numel() </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> model.parameters())</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1e6</span><span style="color:#D73A49;">:.2f</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">M&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># è®­ç»ƒå¾ªç¯</span></span>
<span class="line"><span style="color:#24292E;">optimizer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.optim.AdamW(model.parameters(), </span><span style="color:#E36209;">lr</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">learning_rate)</span></span>
<span class="line"><span style="color:#24292E;">train_losses, val_losses </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [], []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">iter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">range</span><span style="color:#24292E;">(max_iters):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># è®­ç»ƒå¾ªç¯å®ç°</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 1. è·å–batch</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 2. å‰å‘ä¼ æ’­</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 3. è®¡ç®—æŸå¤±</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 4. åå‘ä¼ æ’­</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 5. å‚æ•°æ›´æ–°</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 6. å®šæœŸè¯„ä¼°</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">###################</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç»˜åˆ¶æŸå¤±æ›²çº¿</span></span>
<span class="line"><span style="color:#24292E;">plt.figure(</span><span style="color:#E36209;">figsize</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">plt.plot(train_losses, </span><span style="color:#E36209;">label</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Train Loss&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">color</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;#FF6B6B&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">plt.plot(val_losses, </span><span style="color:#E36209;">label</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Validation Loss&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">color</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;#4ECDC4&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">plt.xlabel(</span><span style="color:#032F62;">&#39;Iteration&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">plt.ylabel(</span><span style="color:#032F62;">&#39;Loss&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">plt.title(</span><span style="color:#032F62;">&#39;Training Progress: Loss Curves&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">plt.legend()</span></span>
<span class="line"><span style="color:#24292E;">plt.grid(</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">, </span><span style="color:#E36209;">alpha</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">plt.savefig(</span><span style="color:#032F62;">&#39;loss_plot.png&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">dpi</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">300</span><span style="color:#24292E;">, </span><span style="color:#E36209;">bbox_inches</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;tight&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ç”Ÿæˆèå£«æ¯”äºšé£æ ¼æ–‡æœ¬</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;AIèå£«æ¯”äºšå¼€å§‹åˆ›ä½œ...&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">context </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> torch.zeros((</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">), </span><span style="color:#E36209;">dtype</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">torch.long, </span><span style="color:#E36209;">device</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">device)</span></span>
<span class="line"><span style="color:#24292E;">generated_text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> decode(model.generate(context, </span><span style="color:#E36209;">max_new_tokens</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2000</span><span style="color:#24292E;">)[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].tolist())</span></span>
<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(generated_text)</span></span></code></pre></div><h3 id="_8ï¸âƒ£-ç»“æœåˆ†æ" tabindex="-1">8ï¸âƒ£ ç»“æœåˆ†æ <a class="header-anchor" href="#_8ï¸âƒ£-ç»“æœåˆ†æ" aria-label="Permalink to &quot;8ï¸âƒ£ ç»“æœåˆ†æ&quot;">â€‹</a></h3><p><strong>å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</strong></p><ol><li><p><strong>Validation Lossæ”¶æ•›å€¼</strong>æ˜¯å¤šå°‘ï¼Ÿ</p></li><li><p><strong>MiniGPTå‚æ•°é‡</strong>ç»Ÿè®¡ï¼ˆåº”è¯¥&lt;1Mï¼‰</p></li><li><p><strong>æ˜¾å­˜å ç”¨</strong>æƒ…å†µï¼ˆåº”è¯¥&lt;1Gï¼‰</p></li></ol><h3 id="_9ï¸âƒ£-æŒ‘æˆ˜æ€§è¿›é˜¶é—®é¢˜" tabindex="-1">9ï¸âƒ£ æŒ‘æˆ˜æ€§è¿›é˜¶é—®é¢˜ <a class="header-anchor" href="#_9ï¸âƒ£-æŒ‘æˆ˜æ€§è¿›é˜¶é—®é¢˜" aria-label="Permalink to &quot;9ï¸âƒ£ æŒ‘æˆ˜æ€§è¿›é˜¶é—®é¢˜&quot;">â€‹</a></h3><ol><li><p><strong>RoPE vs æ­£å¼¦ä½ç½®ç¼–ç </strong></p><ul><li><p>ä¸ºä»€ä¹ˆç°ä»£GPTä½¿ç”¨<strong>Rotary Position Embedding</strong>ï¼Ÿ</p></li><li><p>å°è¯•åœ¨MiniGPTä¸­å®ç°RoPEå¹¶å¯¹æ¯”æ€§èƒ½ï¼</p></li></ul></li><li><p><strong>LayerNormä½ç½®ä¹‹äº‰</strong></p><ul><li><p><strong>Pre-LN</strong> vs <strong>Post-LN</strong>ï¼šä¸ºä»€ä¹ˆå‰è€…æ›´ç¨³å®šï¼Ÿ</p></li><li><p>ä¿®æ”¹ä»£ç å®ç°Pre-LNæ¶æ„å¹¶åˆ†æè®­ç»ƒç¨³å®šæ€§ï¼</p></li></ul></li><li><p><strong>è®¡ç®—å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>å½“block_sizeå¢åŠ åˆ°128æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p></li><li><p>å°è¯•**æ¢¯åº¦æ£€æŸ¥ç‚¹(Gradient Checkpointing)**å‡å°‘æ˜¾å­˜å ç”¨ï¼</p></li></ul></li><li><p><strong>FlashAttentionç®—æ³•</strong></p><ul><li>äº†è§£è¿™ä¸ªè®©Transformeré£èµ·æ¥çš„ç¥å¥‡ç®—æ³•ï¼</li></ul></li></ol><hr><h2 id="âš ï¸-é‡è¦æé†’" tabindex="-1">âš ï¸ é‡è¦æé†’ <a class="header-anchor" href="#âš ï¸-é‡è¦æé†’" aria-label="Permalink to &quot;âš ï¸ é‡è¦æé†’&quot;">â€‹</a></h2><blockquote><p><strong>AIå·¥å…·ä½¿ç”¨</strong>: æœ¬é¢˜<strong>å¼ºçƒˆå»ºè®®çº¯æ‰‹å·¥å®ç°</strong>ï¼è¿™å¯èƒ½æ˜¯ä½ æœ€åä¸€æ¬¡æœ‰æœºä¼šå®Œå…¨ä»é›¶æ‰‹æ’¸è¿™ä¹ˆæ ¸å¿ƒçš„ç®—æ³•äº†ï¼Œå¥½å¥½çæƒœè¿™ä¸ªè¿‡ç¨‹å§ï¼</p></blockquote><hr><h2 id="æäº¤è¦æ±‚" tabindex="-1">æäº¤è¦æ±‚ <a class="header-anchor" href="#æäº¤è¦æ±‚" aria-label="Permalink to &quot;æäº¤è¦æ±‚&quot;">â€‹</a></h2><h3 id="æäº¤å†…å®¹" tabindex="-1">æäº¤å†…å®¹ <a class="header-anchor" href="#æäº¤å†…å®¹" aria-label="Permalink to &quot;æäº¤å†…å®¹&quot;">â€‹</a></h3><ul><li><p><strong>ä»£ç æ–‡ä»¶</strong>: <code>ml-8-å§“å-å­¦å·.py</code></p></li><li><p><strong>ç†è®ºç­”æ¡ˆ</strong>: <code>ml-8-å§“å-å­¦å·.md</code></p></li><li><p>å‹ç¼©åŒ…æäº¤</p></li></ul><h3 id="æäº¤æ–¹å¼" tabindex="-1">æäº¤æ–¹å¼ <a class="header-anchor" href="#æäº¤æ–¹å¼" aria-label="Permalink to &quot;æäº¤æ–¹å¼&quot;">â€‹</a></h3><ul><li><p><strong>é‚®ç®±</strong>: <code>gimmerml401@163.com</code></p></li><li><p><strong>ä¸»é¢˜</strong>: <code>8-å§“å-å­¦å·</code></p></li></ul><blockquote><p>å‡ºé¢˜äººï¼šç™¾äº‹å¯ä¹</p><p>QQï¼š2465800571</p></blockquote>`,55),t=[e];function c(r,y,E,i,F,d){return a(),l("div",null,t)}const C=n(o,[["render",c]]);export{h as __pageData,C as default};
